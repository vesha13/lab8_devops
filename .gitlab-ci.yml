stages:
  - build
  - upload
  - deploy

build_job:
  stage: build
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      changes:
        - app/*
        - app/**/*
  script:
    - cd app
    - yarn install
    - yarn build
    - mv ./build ../pages
  artifacts:
    paths:
      - pages


upload_job:
  stage: upload
  rules:
    - if: $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == $CI_DEFAULT_BRANCH
  script:
    - cd app
    - yarn install
    - yarn build


deploy_job:
  stage: deploy
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      changes:
        - app/*
        - app/**/*
  script:
    - mv ./pages ./public
    - mv ./${TEXTBOOK_OUTPUT_DIRECTORY} ./public/documents
    - mv ./presentations ./public/presentations
    - rm -rf ${DEPLOY_DIR}/*
    - cp -r ./public/. ${DEPLOY_DIR}/.